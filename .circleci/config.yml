# Python CircleCI 2.1 configuration file
# Copyright 2025 Birkbeck College. All rights reserved.
#
# Licensed under the MIT license. See file LICENSE for details.
#
# Author(s): J.S. Pons, George Roussos and Alex Noble
#
version: 2.1

# Define reusable commands to reduce duplication and improve readability
commands:
  install_dependencies:
    description: "Install project dependencies using a virtual environment"
    steps:
      - run:
          name: Install system libraries
          command: |
            sudo apt-get update
            sudo apt-get install -y libsndfile1
      - run:
          name: Setup virtual environment and install dependencies
          command: |
            python3 -m venv venv
            # Persist the virtual environment activation for subsequent steps
            echo 'source venv/bin/activate' >> $BASH_ENV
            source venv/bin/activate
            make dev
      - run:
          name: Install build dependencies
          command: sudo apt-get update && sudo apt-get install -y cmake build-essential

      - run:
          name: Compile libeemd
          command: |
            cd pdkit/voice_features/native/libeemd
            mkdir -p build && cd build
            cmake ..
            make
            cp libeemd.so ../../../_bin/

  # Renamed this command to avoid conflict with the native save_cache step
  custom_save_cache:
    description: "Save a cache of the virtual environment"
    parameters:
      cache_key_prefix:
        type: string
        default: "v1-dependencies"
    steps:
      - save_cache:
          key: << parameters.cache_key_prefix >>-{{ .Branch }}-{{ checksum "requirements.txt" }}-{{ checksum "setup.py" }}
          paths:
            - "venv"

  # Renamed this command to avoid conflict with the native restore_cache step
  custom_restore_cache:
    description: "Restore a cache of the virtual environment"
    parameters:
      cache_key_prefix:
        type: string
        default: "v1-dependencies"
    steps:
      - restore_cache:
          keys:
            - << parameters.cache_key_prefix >>-{{ .Branch }}-{{ checksum "requirements.txt" }}-{{ checksum "setup.py" }}
            - << parameters.cache_key_prefix >>-{{ .Branch }}-{{ checksum "requirements.txt" }}
            - << parameters.cache_key_prefix >>-{{ .Branch }}

# Define reusable jobs
jobs:
  build:
    docker:
      - image: cimg/python:3.11.6
    steps:
      - checkout
      # Use the renamed custom command
      - custom_restore_cache:
          cache_key_prefix: "v1-dependencies"
      - install_dependencies
      # Use the renamed custom command
      - custom_save_cache:
          cache_key_prefix: "v1-dependencies"
      - run:
          name: Run tests
          command: make test

  deploy:
    docker:
      - image: cimg/python:3.11.6
    steps:
      - checkout
      # Use the renamed custom command
      - custom_restore_cache:
          cache_key_prefix: "v1-dependencies"
      - install_dependencies
      # Use the renamed custom command
      - custom_save_cache:
          cache_key_prefix: "v1-dependencies"
      - run:
          name: Verify git tag vs. version
          command: python setup.py verify
      - run:
          name: Initialize .pypirc
          command: |
            echo -e "[pypi]" >> ~/.pypirc
            echo -e "username = __token__" >> ~/.pypirc
            echo -e "password = $PYPI_PASSWORD" >> ~/.pypirc
      - run:
          name: Create and upload packages
          command: |
            make package
            twine upload dist/*

workflows:
  version: 2
  build_and_deploy:
    jobs:
      - build:
          filters:
            tags:
              only: /.*/
      - deploy:
          requires:
            - build
          filters:
            tags:
              # This regex matches semantic versioning tags like 1.2.3
              only: /^v?[0-9]+(\.[0-9]+){2,3}$/
            branches:
              ignore: /.*/
